const CONFIG={API:{BASE_URL: 'http: ENDPOINTS:{USER: '/user',USER_PROFILE:(userId)=> `/user/${userId}/profile`,CONTRACTS: '/contracts',CONTRACTS_BY_USER:(userId)=> `/contracts/${userId}`,CONTRACT_ACCEPT:(contractId)=> `/contracts/${contractId}/accept`,ACTION_USE: '/action/use'},TIMEOUT: 10000},UI:{MESSAGE_DISPLAY_DURATION: 5000,FADE_DURATION: 300,ANIMATION_DURATION: 300},GAME:{SKILL_ACTION_TIME: 5,MIN_CONTRACT_REWARD: 1,MIN_CONTRACT_LEVEL: 1},STORAGE:{USER_ID: 'echi_di_aethel_user_id'},CLASSES:{SUCCESS: 'success',ERROR: 'error',DEFAULT: 'default',HIDDEN: 'hidden',ACTIVE: 'active',LOADING: 'loading'}};if(typeof module !=='undefined' && module.exports){module.exports=CONFIG;}class ApiService{constructor(config){this.config=config;this.baseURL=config.API.BASE_URL;}async request(endpoint,options={}){const url=`${this.baseURL}${endpoint}`;const defaultOptions={timeout: this.config.API.TIMEOUT,headers:{'Content-Type': 'application/json'}};const requestOptions={...defaultOptions,...options};try{const response=await fetch(url,requestOptions);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const data=await response.json();return{success: true,data};}catch(error){console.error('API Request failed:',error);return{success: false,error: error.message || 'Unknown error occurred'};}}async createUser(username){return this.request(this.config.API.ENDPOINTS.USER,{method: 'POST',body: JSON.stringify({username})});}async getUserProfile(userId){return this.request(this.config.API.ENDPOINTS.USER_PROFILE(userId),{method: 'GET'});}async getContracts(userId){return this.request(this.config.API.ENDPOINTS.CONTRACTS_BY_USER(userId),{method: 'GET'});}async acceptContract(contractId,acceptorId){return this.request(this.config.API.ENDPOINTS.CONTRACT_ACCEPT(contractId),{method: 'POST',body: JSON.stringify({acceptor_id: acceptorId})});}async createContract(contractData){return this.request(this.config.API.ENDPOINTS.CONTRACTS,{method: 'POST',body: JSON.stringify(contractData)});}async useSkill(userId,skillName,actionTime=this.config.GAME.SKILL_ACTION_TIME){return this.request(this.config.API.ENDPOINTS.ACTION_USE,{method: 'POST',body: JSON.stringify({user_id: userId,skill_name: skillName,action_time: actionTime})});}}const apiService=new ApiService(CONFIG);if(typeof module !=='undefined' && module.exports){module.exports=ApiService;}class UIService{constructor(config){this.config=config;this.messageElements=new Map();this.initializeMessageElements();}initializeMessageElements(){const messageIds=['message','action-message','contract-message'];messageIds.forEach(id=>{const element=document.getElementById(id);if(element){this.messageElements.set(id,element);}});}showMessage(elementId,message,type='default'){const element=this.messageElements.get(elementId);if(!element){console.warn(`Message element with ID '${elementId}' not found`);return;}element.textContent=message;element.className='';element.classList.add(type);element.style.display='block';if(type===this.config.CLASSES.DEFAULT){element.style.backgroundColor='#eee';element.style.color='#333';}setTimeout(()=>{this.hideMessage(elementId);},this.config.UI.MESSAGE_DISPLAY_DURATION);}hideMessage(elementId){const element=this.messageElements.get(elementId);if(element){element.style.transition=`opacity ${this.config.UI.FADE_DURATION}ms`;element.style.opacity='0';setTimeout(()=>{element.style.display='none';element.style.opacity='1';},this.config.UI.FADE_DURATION);}}toggleElement(elementId,show=null,method='slide'){const element=document.getElementById(elementId);if(!element)return;const isVisible=element.style.display !=='none' && !element.classList.contains(this.config.CLASSES.HIDDEN);const shouldShow=show !==null ? show : !isVisible;if(method==='slide'){if(shouldShow){$(element).slideDown(this.config.UI.ANIMATION_DURATION);}else{$(element).slideUp(this.config.UI.ANIMATION_DURATION);}}else if(method==='fade'){if(shouldShow){$(element).fadeIn(this.config.UI.ANIMATION_DURATION);}else{$(element).fadeOut(this.config.UI.ANIMATION_DURATION);}}else{element.style.display=shouldShow ? 'block' : 'none';}}setLoadingState(elementId,loading=true,loadingText='Caricamento...'){const element=document.getElementById(elementId);if(!element)return;if(loading){element.classList.add(this.config.CLASSES.LOADING);element.disabled=true;if(element.tagName==='BUTTON'){element.dataset.originalText=element.textContent;element.textContent=loadingText;}}else{element.classList.remove(this.config.CLASSES.LOADING);element.disabled=false;if(element.tagName==='BUTTON' && element.dataset.originalText){element.textContent=element.dataset.originalText;delete element.dataset.originalText;}}}updateProfile(profileData){const nameElement=document.getElementById('profile-name');const traitElement=document.getElementById('profile-trait');const traitDescElement=document.getElementById('trait-description');if(nameElement)nameElement.textContent=profileData.username;if(traitElement && traitDescElement){if(profileData.trait){traitElement.textContent=profileData.trait.name;traitDescElement.textContent=`Effetto: ${profileData.trait.description}`;}else{traitElement.textContent='Nessun Tratto Assegnato';traitDescElement.textContent='';}}}renderSkills(skills,onSkillUse){const container=document.getElementById('skill-output');if(!container)return;let html='';skills.forEach(skill=>{const levelProgress=skill.xp_to_next > 0 ?(skill.xp_on_level / skill.xp_to_next)* 100 : 100;const xpDisplay=skill.xp_to_next > 0 ? `${skill.xp_on_level}/ ${skill.xp_to_next}` : 'MAESTRO';html +=` <div class="skill-item"> <div class="skill-info"> <strong>${skill.name}</strong> [${skill.base_class}] - Livello ${skill.current_level}<br> <span class="skill-xp">XP: ${xpDisplay}</span> <div class="skill-progress"> <div class="skill-progress-bar" style="width: ${levelProgress}%"></div> </div> </div> <button class="use-skill-btn" data-skill-name="${skill.name}"> Usa ${skill.name}</button> </div> `;});container.innerHTML=html;container.querySelectorAll('.use-skill-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{const skillName=e.target.dataset.skillName;onSkillUse(skillName);});});}renderContracts(contracts,currentUserId,onContractAccept){const container=document.getElementById('contracts-list-output');if(!container)return;let html='';if(contracts.length===0){html='<p class="no-contracts">Nessun contratto disponibile al tuo livello di competenza. Continua ad allenarti!</p>';}else{contracts.forEach(contract=>{const isProposer=contract.proposer_id==currentUserId;const statusText=contract.status==='OPEN' ? 'APERTO' : contract.status;const acceptButton=isProposer ? `<button class="contract-owner-btn">Pubblicato da te</button>` : `<button class="accept-contract-btn" data-contract-id="${contract.contract_id}">Accetta Contratto</button>`;html +=` <div class="contract-item"> <div class="contract-details"> <strong>${contract.title}</strong>(Stato: ${statusText})<br> <span class="contract-requirement">Richiesto: ${contract.required_skill_name}(Liv. ${contract.required_level}+)</span> <span class="contract-proposer"> | Proponente: ${contract.proposer_name}</span> </div> <div class="contract-actions"> <span class="contract-reward">${contract.reward_amount}Oro</span> <div class="contract-button">${acceptButton}</div> </div> </div> `;});}container.innerHTML=html;container.querySelectorAll('.accept-contract-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{const contractId=e.target.dataset.contractId;onContractAccept(contractId);});});}populateSkillDropdown(skills){const select=document.getElementById('required-skill-name');if(!select)return;select.disabled=false;select.innerHTML='<option value="">Seleziona Mestiere Richiesto</option>';skills.forEach(skillName=>{const option=document.createElement('option');option.value=skillName;option.textContent=skillName;select.appendChild(option);});}clearForm(formId){const form=document.getElementById(formId);if(!form)return;const inputs=form.querySelectorAll('input,select,textarea');inputs.forEach(input=>{if(input.type==='checkbox' || input.type==='radio'){input.checked=false;}else{input.value='';}});}toggleUserSections(hasUser){const creationForm=document.getElementById('creation-form');const profile=document.getElementById('profile');const contractBoard=document.getElementById('contract-board');if(hasUser){if(creationForm)creationForm.style.display='none';if(profile)profile.style.display='block';if(contractBoard)contractBoard.style.display='block';}else{if(creationForm)creationForm.style.display='block';if(profile)profile.style.display='none';if(contractBoard)contractBoard.style.display='none';}}}const uiService=new UIService(CONFIG);if(typeof module !=='undefined' && module.exports){module.exports=UIService;}class StateManager{constructor(){this.state={currentUserId: null,userProfile: null,availableSkills: [],contracts: [],isLoading: false,error: null};this.listeners=new Map();}getState(){return{...this.state};}setState(updates){const prevState={...this.state};this.state={...this.state,...updates};this.notifyListeners(prevState,this.state);}subscribe(key,callback){if(!this.listeners.has(key)){this.listeners.set(key,new Set());}this.listeners.get(key).add(callback);return()=>{const listeners=this.listeners.get(key);if(listeners){listeners.delete(callback);}};}notifyListeners(prevState,newState){this.listeners.forEach((callbacks,key)=>{if(prevState[key] !==newState[key]){callbacks.forEach(callback=>{try{callback(newState[key],prevState[key]);}catch(error){console.error(`Error in state listener for key '${key}':`,error);}});}});}setLoading(loading){this.setState({isLoading: loading});}setError(error){this.setState({error});}setCurrentUser(userId){this.setState({currentUserId: userId});if(userId){localStorage.setItem(CONFIG.STORAGE.USER_ID,userId);}else{localStorage.removeItem(CONFIG.STORAGE.USER_ID);}}setUserProfile(profile){this.setState({userProfile: profile});if(profile && profile.skills){const uniqueSkillNames=[...new Set(profile.skills.map(s=> s.name))];this.setState({availableSkills: uniqueSkillNames});}}setContracts(contracts){this.setState({contracts});}addContract(contract){const currentContracts=[...this.state.contracts];currentContracts.unshift(contract);this.setState({contracts: currentContracts});}updateContract(contractId,updates){const currentContracts=[...this.state.contracts];const index=currentContracts.findIndex(c=> c.contract_id===contractId);if(index !==-1){currentContracts[index]={...currentContracts[index],...updates};this.setState({contracts: currentContracts});}}removeContract(contractId){const currentContracts=this.state.contracts.filter(c=> c.contract_id !==contractId);this.setState({contracts: currentContracts});}clearState(){this.setState({currentUserId: null,userProfile: null,availableSkills: [],contracts: [],isLoading: false,error: null});}initializeFromStorage(){const savedUserId=localStorage.getItem(CONFIG.STORAGE.USER_ID);if(savedUserId){this.setCurrentUser(savedUserId);}}}const stateManager=new StateManager();if(typeof module !=='undefined' && module.exports){module.exports=StateManager;}class GameService{constructor(apiService,uiService,stateManager){this.api=apiService;this.ui=uiService;this.state=stateManager;}async initialize(){this.state.initializeFromStorage();const currentUserId=this.state.getState().currentUserId;if(currentUserId){await this.loadUserProfile(currentUserId);}else{this.ui.toggleUserSections(false);}}async createUser(username){if(!username || username.trim()===''){this.ui.showMessage('message','Inserisci un nome utente valido.','error');return;}this.ui.showMessage('message','Creazione in corso...','default');this.state.setLoading(true);const response=await this.api.createUser(username.trim());if(response.success){this.ui.showMessage('message',response.data.message,'success');this.state.setCurrentUser(response.data.user_id);await this.loadUserProfile(response.data.user_id);}else{this.ui.showMessage('message',`Errore: ${response.error}`,'error');}this.state.setLoading(false);}async loadUserProfile(userId){this.state.setLoading(true);this.state.setError(null);try{const response=await this.api.getUserProfile(userId);if(response.success){this.state.setUserProfile(response.data);this.ui.updateProfile(response.data);this.ui.renderSkills(response.data.skills,(skillName)=> this.useSkill(skillName));this.ui.populateSkillDropdown(this.state.getState().availableSkills);this.ui.toggleUserSections(true);await this.loadContracts(userId);}else{this.ui.showMessage('message','Errore nel caricamento del profilo.','error');this.state.setError(response.error);}}catch(error){console.error('Error loading user profile:',error);this.ui.showMessage('message','Errore nel caricamento del profilo.','error');this.state.setError(error.message);}finally{this.state.setLoading(false);}}async useSkill(skillName){const currentUserId=this.state.getState().currentUserId;if(!currentUserId)return;this.ui.showMessage('action-message',`Esecuzione di ${skillName}...`,'default');const response=await this.api.useSkill(currentUserId,skillName);if(response.success){const messageType=response.data.level_up ? 'success' : 'default';this.ui.showMessage('action-message',response.data.message,messageType);await this.loadUserProfile(currentUserId);}else{this.ui.showMessage('action-message',`Errore nell'azione: ${response.error}`,'error');}}async loadContracts(userId){const contractsContainer=document.getElementById('contracts-list-output');if(contractsContainer){contractsContainer.innerHTML='Caricamento contratti filtrati...';}const response=await this.api.getContracts(userId);if(response.success){this.state.setContracts(response.data);this.ui.renderContracts(response.data,userId,(contractId)=> this.acceptContract(contractId));}else{console.error('Error loading contracts:',response.error);if(contractsContainer){contractsContainer.innerHTML='<p class="text-center text-red-500">Errore nel caricamento della bacheca.</p>';}}}async acceptContract(contractId){if(!confirm("Sei sicuro di voler accettare questo contratto?")){return;}const currentUserId=this.state.getState().currentUserId;if(!currentUserId)return;this.ui.showMessage('contract-message','Accettazione in corso...','default');const response=await this.api.acceptContract(contractId,currentUserId);if(response.success){this.ui.showMessage('contract-message',response.data.message,'success');this.state.updateContract(contractId,{status: 'ACCEPTED'});await this.loadContracts(currentUserId);}else{this.ui.showMessage('contract-message',`Errore: ${response.error}`,'error');}}async createContract(contractData){const{title,skillName,level,reward}=contractData;if(!title || !skillName || !level || !reward || reward <=0){this.ui.showMessage('contract-message','Compila tutti i campi correttamente.','error');return;}const currentUserId=this.state.getState().currentUserId;if(!currentUserId)return;this.ui.showMessage('contract-message','Pubblicazione in corso(Escrow)...','default');const contractPayload={proposer_id: currentUserId,title: title.trim(),required_skill_name: skillName,required_level: parseInt(level),reward_amount: parseInt(reward)};const response=await this.api.createContract(contractPayload);if(response.success){this.ui.showMessage('contract-message',response.data.message,'success');this.ui.toggleElement('contract-create',false);this.state.addContract(response.data.contract);await this.loadContracts(currentUserId);}else{this.ui.showMessage('contract-message',`Errore di pubblicazione: ${response.error}`,'error');}}async refreshUserData(){const currentUserId=this.state.getState().currentUserId;if(currentUserId){await this.loadUserProfile(currentUserId);}}logout(){this.state.clearState();this.ui.toggleUserSections(false);this.ui.clearForm('creation-form');}getContractFormData(){return{title: document.getElementById('contract-title')?.value || '',skillName: document.getElementById('required-skill-name')?.value || '',level: document.getElementById('required-level')?.value || '',reward: document.getElementById('reward-amount')?.value || ''};}validateContractForm(formData){const errors=[];if(!formData.title.trim()){errors.push('Il titolo è obbligatorio');}if(!formData.skillName){errors.push('Seleziona un mestiere richiesto');}if(!formData.level || isNaN(formData.level)|| parseInt(formData.level)< CONFIG.GAME.MIN_CONTRACT_LEVEL){errors.push('Il livello deve essere un numero valido');}if(!formData.reward || isNaN(formData.reward)|| parseInt(formData.reward)< CONFIG.GAME.MIN_CONTRACT_REWARD){errors.push('La ricompensa deve essere un numero valido');}return{isValid: errors.length===0,errors};}}if(typeof module !=='undefined' && module.exports){module.exports=GameService;}class App{constructor(){this.gameService=new GameService(apiService,uiService,stateManager);this.initializeEventListeners();}async init(){try{await this.gameService.initialize();}catch(error){console.error('Failed to initialize application:',error);uiService.showMessage('message','Errore durante l\'inizializzazione dell\'applicazione.','error');}}initializeEventListeners(){this.addEventListener('create-btn','click',()=> this.handleUserCreation());this.addEventListener('refresh-btn','click',()=> this.handleRefresh());this.addEventListener('toggle-create-form-btn','click',()=> this.handleToggleContractForm());this.addEventListener('create-contract-btn','click',()=> this.handleCreateContract());this.addEventListener('contract-title','input',()=> this.validateContractForm());this.addEventListener('required-skill-name','change',()=> this.validateContractForm());this.addEventListener('required-level','input',()=> this.validateContractForm());this.addEventListener('reward-amount','input',()=> this.validateContractForm());document.addEventListener('keydown',(e)=> this.handleKeyboardShortcuts(e));this.setupStateListeners();}addEventListener(elementId,event,handler){const element=document.getElementById(elementId);if(element){element.addEventListener(event,handler.bind(this));}else{console.warn(`Element with ID '${elementId}' not found for event '${event}'`);}}async handleUserCreation(){const usernameInput=document.getElementById('username');const username=usernameInput?.value?.trim();if(!username){uiService.showMessage('message','Inserisci un nome utente valido.','error');return;}await this.gameService.createUser(username);}async handleRefresh(){const currentUserId=stateManager.getState().currentUserId;if(currentUserId){await this.gameService.refreshUserData();}}handleToggleContractForm(){uiService.toggleElement('contract-create',null,'slide');}async handleCreateContract(){const formData=this.gameService.getContractFormData();const validation=this.gameService.validateContractForm(formData);if(!validation.isValid){uiService.showMessage('contract-message',validation.errors.join(','),'error');return;}await this.gameService.createContract(formData);}validateContractForm(){const formData=this.gameService.getContractFormData();const validation=this.gameService.validateContractForm(formData);const createButton=document.getElementById('create-contract-btn');if(createButton){createButton.disabled=!validation.isValid;}}handleKeyboardShortcuts(e){if((e.ctrlKey || e.metaKey)&& e.key==='Enter'){const createBtn=document.getElementById('create-btn');if(createBtn && createBtn.offsetParent !==null){createBtn.click();}}if(e.key==='Escape'){const contractForm=document.getElementById('contract-create');if(contractForm && contractForm.style.display !=='none'){uiService.toggleElement('contract-create',false);}}}setupStateListeners(){stateManager.subscribe('isLoading',(isLoading)=>{const refreshBtn=document.getElementById('refresh-btn');if(refreshBtn){uiService.setLoadingState('refresh-btn',isLoading,'Caricamento...');}});stateManager.subscribe('error',(error)=>{if(error){console.error('Application error:',error);}});stateManager.subscribe('currentUserId',(userId)=>{if(!userId){uiService.clearForm('creation-form');}});}handleError(error){console.error('Application error:',error);uiService.showMessage('message','Si è verificato un errore imprevisto.','error');stateManager.setError(error.message);}destroy(){document.removeEventListener('keydown',this.handleKeyboardShortcuts);stateManager.clearState();}}document.addEventListener('DOMContentLoaded',async()=>{window.addEventListener('error',(e)=>{console.error('Global error:',e.error);});window.addEventListener('unhandledrejection',(e)=>{console.error('Unhandled promise rejection:',e.reason);});const app=new App();await app.init();window.app=app;});if(typeof module !=='undefined' && module.exports){module.exports=App;}